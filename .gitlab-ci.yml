stages:
  - build

variables:
  SBOM_DIR: "sbom"
  REPORT_DIR: "reports"
  BUILD_LOG: "build-output.log"
  SBOM_SIGNING_ALGO: "RS384"
  SBOM_SIGNING_DIGEST: "sha384"
  SIGNING_METHOD: "none"
  GPG_SIGNING_ALGO: "urn:openpgp:rsa3072"
  PQ_SIGNING_ALGO: "urn:nist:alg:ml-dsa-87"
  PQ_SIGNING_DIGEST: "sha512"
  PQ_OPENSSL_IMAGE: "openquantumsafe/oqs-openssl:latest"
  PQ_OPENSSL_PROVIDERS: "oqsprovider default"

build_sbom_scan:
  stage: build
  image: docker:24
  services:
    - name: docker:24-dind
      command: ["--tls=false"]
  variables:
    DOCKER_HOST: "tcp://docker:2375"
    DOCKER_TLS_CERTDIR: ""
  before_script:
    - apk add --no-cache bash curl jq python3 openssl build-base
    - mkdir -p "$SBOM_DIR" "$REPORT_DIR" sbom-pipeline-app/build
    - |
      case "$SIGNING_METHOD" in
        none)
          echo "SBOM signing disabled (SIGNING_METHOD=none)."
          ;;
        openssl)
          if [ -z "$SBOM_SIGNING_KEY_B64" ] || [ -z "$SBOM_SIGNING_PUB_B64" ]; then
            echo "Missing SBOM_SIGNING_KEY_B64 or SBOM_SIGNING_PUB_B64 CI variable."
            exit 1
          fi
          echo "$SBOM_SIGNING_KEY_B64" | base64 -d > "$SBOM_DIR/sbom-signing.key"
          echo "$SBOM_SIGNING_PUB_B64" | base64 -d > "$SBOM_DIR/sbom-signing.pub"
          ;;
        gpg)
          if [ -z "$SBOM_GPG_PRIVATE_KEY_B64" ] || [ -z "$SBOM_GPG_PUBLIC_KEY_B64" ]; then
            echo "Missing SBOM_GPG_PRIVATE_KEY_B64 or SBOM_GPG_PUBLIC_KEY_B64 CI variable."
            exit 1
          fi
          echo "$SBOM_GPG_PRIVATE_KEY_B64" | base64 -d > "$SBOM_DIR/sbom-gpg-private.asc"
          echo "$SBOM_GPG_PUBLIC_KEY_B64" | base64 -d > "$SBOM_DIR/sbom-gpg-public.asc"
          ;;
        pq)
          if [ -z "$SBOM_PQ_KEY_B64" ] || [ -z "$SBOM_PQ_PUB_B64" ]; then
            echo "Missing SBOM_PQ_KEY_B64 or SBOM_PQ_PUB_B64 CI variable."
            exit 1
          fi
          echo "$SBOM_PQ_KEY_B64" | base64 -d > "$SBOM_DIR/sbom-pq.key"
          echo "$SBOM_PQ_PUB_B64" | base64 -d > "$SBOM_DIR/sbom-pq.pub"
          ;;
        *)
          echo "Unknown SIGNING_METHOD: $SIGNING_METHOD (use openssl|gpg|pq)"
          exit 1
          ;;
      esac
  script:
    - echo "==> Build example C++ application"
    - make -C sbom-pipeline-app 2>&1 | tee "$REPORT_DIR/$BUILD_LOG"
    - echo "==> Generate SBOMs (CycloneDX) with Syft"
    - docker pull anchore/syft:latest
    - docker run --rm -v "$CI_PROJECT_DIR:/src" anchore/syft:latest dir:/src/sbom-pipeline-app -o cyclonedx-json > "$SBOM_DIR/sbom-example-source.json"
    - docker run --rm -v "$CI_PROJECT_DIR:/src" anchore/syft:latest dir:/src/sbom-pipeline-app/build -o cyclonedx-json > "$SBOM_DIR/sbom-example-build.json"
    - echo "==> Enrich SBOMs with custom metadata"
    - docker pull mcr.microsoft.com/powershell:7.4-ubuntu-22.04
    - >
      docker run --rm -v "$CI_PROJECT_DIR:/work" -w /work mcr.microsoft.com/powershell:7.4-ubuntu-22.04
      pwsh -File merge-sbom.ps1
      -InputSbom "$SBOM_DIR/sbom-example-source.json"
      -AppMetadata "sbom-pipeline-app/app-metadata.json"
      -OutputSbom "$SBOM_DIR/sbom-example-source.enriched.json"
    - >
      docker run --rm -v "$CI_PROJECT_DIR:/work" -w /work mcr.microsoft.com/powershell:7.4-ubuntu-22.04
      pwsh -File merge-sbom.ps1
      -InputSbom "$SBOM_DIR/sbom-example-build.json"
      -AppMetadata "sbom-pipeline-app/app-metadata.json"
      -OutputSbom "$SBOM_DIR/sbom-example-build.enriched.json"
    - echo "==> Sign SBOMs ($SIGNING_METHOD)"
    - |
      if [ "$SIGNING_METHOD" = "openssl" ]; then
        python3 sbom-signing/sign-sbom.py --input "$SBOM_DIR/sbom-example-source.enriched.json" --output "$SBOM_DIR/sbom-example-source.enriched.signed.json" --key "$SBOM_DIR/sbom-signing.key" --algorithm "$SBOM_SIGNING_ALGO" --digest "$SBOM_SIGNING_DIGEST" --key-id "gitlab-example-signing"
        python3 sbom-signing/sign-sbom.py --input "$SBOM_DIR/sbom-example-build.enriched.json" --output "$SBOM_DIR/sbom-example-build.enriched.signed.json" --key "$SBOM_DIR/sbom-signing.key" --algorithm "$SBOM_SIGNING_ALGO" --digest "$SBOM_SIGNING_DIGEST" --key-id "gitlab-example-signing"
      elif [ "$SIGNING_METHOD" = "gpg" ]; then
        docker run --rm -e SBOM_GPG_KEY_ID -e GPG_SIGNING_ALGO -v "$CI_PROJECT_DIR:/work" -w /work mcr.microsoft.com/powershell:7.4-ubuntu-22.04 bash -lc \
          "apt-get update >/dev/null && apt-get install -y gnupg openssl >/dev/null && \
           gpg --batch --import sbom/sbom-gpg-private.asc >/dev/null && \
           pwsh -File sbom-signing/sign-sbom.ps1 -Signer gpg -Algorithm \"$GPG_SIGNING_ALGO\" -GpgKeyId \"$SBOM_GPG_KEY_ID\" -InputSbom \"$SBOM_DIR/sbom-example-source.enriched.json\" -OutputSbom \"$SBOM_DIR/sbom-example-source.enriched.signed.json\" && \
           pwsh -File sbom-signing/sign-sbom.ps1 -Signer gpg -Algorithm \"$GPG_SIGNING_ALGO\" -GpgKeyId \"$SBOM_GPG_KEY_ID\" -InputSbom \"$SBOM_DIR/sbom-example-build.enriched.json\" -OutputSbom \"$SBOM_DIR/sbom-example-build.enriched.signed.json\""
      elif [ "$SIGNING_METHOD" = "pq" ]; then
        providers=""
        for p in $PQ_OPENSSL_PROVIDERS; do providers="$providers --openssl-provider $p"; done
        docker run --rm -v "$CI_PROJECT_DIR:/work" -w /work "$PQ_OPENSSL_IMAGE" /bin/sh -lc \
          "command -v python3 >/dev/null 2>&1 || (apt-get update >/dev/null && apt-get install -y python3 >/dev/null); \
           python3 sbom-signing/sign-sbom.py --input \"$SBOM_DIR/sbom-example-source.enriched.json\" --output \"$SBOM_DIR/sbom-example-source.enriched.signed.json\" --key \"$SBOM_DIR/sbom-pq.key\" --algorithm \"$PQ_SIGNING_ALGO\" --digest \"$PQ_SIGNING_DIGEST\" $providers && \
           python3 sbom-signing/sign-sbom.py --input \"$SBOM_DIR/sbom-example-build.enriched.json\" --output \"$SBOM_DIR/sbom-example-build.enriched.signed.json\" --key \"$SBOM_DIR/sbom-pq.key\" --algorithm \"$PQ_SIGNING_ALGO\" --digest \"$PQ_SIGNING_DIGEST\" $providers"
      fi
    - echo "==> Verify SBOM signature ($SIGNING_METHOD)"
    - |
      if [ "$SIGNING_METHOD" = "openssl" ]; then
        python3 sbom-signing/verify-sbom.py --input "$SBOM_DIR/sbom-example-source.enriched.signed.json" --public-key "$SBOM_DIR/sbom-signing.pub" --digest "$SBOM_SIGNING_DIGEST"
        python3 sbom-signing/verify-sbom.py --input "$SBOM_DIR/sbom-example-build.enriched.signed.json" --public-key "$SBOM_DIR/sbom-signing.pub" --digest "$SBOM_SIGNING_DIGEST"
      elif [ "$SIGNING_METHOD" = "gpg" ]; then
        docker run --rm -v "$CI_PROJECT_DIR:/work" -w /work mcr.microsoft.com/powershell:7.4-ubuntu-22.04 bash -lc \
          "apt-get update >/dev/null && apt-get install -y gnupg openssl >/dev/null && \
           gpg --batch --import sbom/sbom-gpg-public.asc >/dev/null && \
           pwsh -File sbom-signing/verify-sbom.ps1 -Signer gpg -InputSbom \"$SBOM_DIR/sbom-example-source.enriched.signed.json\" && \
           pwsh -File sbom-signing/verify-sbom.ps1 -Signer gpg -InputSbom \"$SBOM_DIR/sbom-example-build.enriched.signed.json\""
      elif [ "$SIGNING_METHOD" = "pq" ]; then
        providers=""
        for p in $PQ_OPENSSL_PROVIDERS; do providers="$providers --openssl-provider $p"; done
        docker run --rm -v "$CI_PROJECT_DIR:/work" -w /work "$PQ_OPENSSL_IMAGE" /bin/sh -lc \
          "command -v python3 >/dev/null 2>&1 || (apt-get update >/dev/null && apt-get install -y python3 >/dev/null); \
           python3 sbom-signing/verify-sbom.py --input \"$SBOM_DIR/sbom-example-source.enriched.signed.json\" --public-key \"$SBOM_DIR/sbom-pq.pub\" --digest \"$PQ_SIGNING_DIGEST\" $providers && \
           python3 sbom-signing/verify-sbom.py --input \"$SBOM_DIR/sbom-example-build.enriched.signed.json\" --public-key \"$SBOM_DIR/sbom-pq.pub\" --digest \"$PQ_SIGNING_DIGEST\" $providers"
      fi
    - echo "==> Select SBOMs for validation"
    - |
      if [ "$SIGNING_METHOD" = "none" ]; then
        SBOM_SOURCE="$SBOM_DIR/sbom-example-source.enriched.json"
        SBOM_BUILD="$SBOM_DIR/sbom-example-build.enriched.json"
      else
        SBOM_SOURCE="$SBOM_DIR/sbom-example-source.enriched.signed.json"
        SBOM_BUILD="$SBOM_DIR/sbom-example-build.enriched.signed.json"
      fi
      echo "Using SBOM_SOURCE=$SBOM_SOURCE"
      echo "Using SBOM_BUILD=$SBOM_BUILD"
    - echo "==> Validate SBOM structure (CycloneDX-CLI) and NTIA checks"
    - docker pull cyclonedx/cyclonedx-cli:latest
    - docker pull hoppr/hopctl:latest
    - |
      set +e
      docker run --rm -v "$CI_PROJECT_DIR:/data" cyclonedx/cyclonedx-cli:latest validate --input-file "/data/$SBOM_SOURCE"
      raw_validate=$?
      docker run --rm -v "$CI_PROJECT_DIR:/data" cyclonedx/cyclonedx-cli:latest validate --input-file "/data/$SBOM_BUILD"
      enriched_validate=$?

      docker run --rm -v "$CI_PROJECT_DIR:/work" -w /work mcr.microsoft.com/powershell:7.4-ubuntu-22.04 pwsh -File ./check-ntia.ps1 -SbomFile "$SBOM_SOURCE"
      ntia_local=$?

      docker run --rm -v "$CI_PROJECT_DIR:/data" -w /data hoppr/hopctl validate sbom --sbom "$SBOM_SOURCE" --profile ntia --log-file "/data/$REPORT_DIR/hoppr-raw.log" --verbose
      hoppr_raw=$?
      docker run --rm -v "$CI_PROJECT_DIR:/data" -w /data hoppr/hopctl validate sbom --sbom "$SBOM_BUILD" --profile ntia --log-file "/data/$REPORT_DIR/hoppr-enriched.log" --verbose
      hoppr_enriched=$?
      set -e

      {
        echo "SBOM Requirements Summary"
        echo "========================="
        echo "CycloneDX validate (raw):      $([ $raw_validate -eq 0 ] && echo PASS || echo FAIL)"
        echo "CycloneDX validate (enriched): $([ $enriched_validate -eq 0 ] && echo PASS || echo FAIL)"
        echo "NTIA Minimum Elements (local): $([ $ntia_local -eq 0 ] && echo PASS || echo FAIL)"
        echo "Hoppr NTIA (raw):              $([ $hoppr_raw -eq 0 ] && echo PASS || echo WARN)"
        echo "Hoppr NTIA (enriched):         $([ $hoppr_enriched -eq 0 ] && echo PASS || echo WARN)"
      } > "$REPORT_DIR/requirements-summary.txt"

      if [ $raw_validate -ne 0 ] || [ $enriched_validate -ne 0 ] || [ $ntia_local -ne 0 ]; then
        echo "SBOM requirement checks failed. See $REPORT_DIR/requirements-summary.txt"
        exit 1
      fi
    - echo "==> Vulnerability scan using Grype"
    - docker pull anchore/grype:latest
    - docker run --rm -v "$CI_PROJECT_DIR:/data" anchore/grype:latest sbom:/data/$SBOM_DIR/sbom-example-source.enriched.json -o json > "$REPORT_DIR/grype-report.json"
    - docker run --rm -v "$CI_PROJECT_DIR:/data" anchore/grype:latest sbom:/data/$SBOM_DIR/sbom-example-source.enriched.json -o table > "$REPORT_DIR/grype-report.txt"
    - echo "==> Vulnerability analysis summary"
    - >
      jq -r '
        def count(sev): ( [ .matches[]? | select(.vulnerability.severity == sev) ] | length );
        "Vulnerability Analysis Summary",
        "==============================",
        ("Total: " + ( [ .matches[]? ] | length | tostring )),
        ("Critical: " + (count("Critical") | tostring)),
        ("High: " + (count("High") | tostring)),
        ("Medium: " + (count("Medium") | tostring)),
        ("Low: " + (count("Low") | tostring)),
        ("Negligible: " + (count("Negligible") | tostring)),
        "",
        "Top Findings (up to 10):",
        ( [ .matches[]? | "\(.vulnerability.id) | \(.vulnerability.severity) | \(.artifact.name) \(.artifact.version // "")" ][0:10] | .[] )
      ' "$REPORT_DIR/grype-report.json" > "$REPORT_DIR/vulnerability-analysis.txt"
  artifacts:
    when: always
    paths:
      - sbom-pipeline-app/build/
      - sbom/
      - reports/
    expire_in: 1 week
