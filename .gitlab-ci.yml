stages:
  - build
  - sbom

variables:
  IMAGE_NAME: "ums-cpp-app"
  IMAGE_TAG: "1.0"
  IMAGE_TAR: "ums-image.tar"
  DOCKER_TLS_CERTDIR: ""

.default_docker_job:
  image: docker:24.0.5
  services:
    - docker:24.0.5-dind
  before_script:
    - echo "Using Docker-in-Docker"
    - docker info

# -------------------------------
# STAGE 1 — BUILD IMAGE
# -------------------------------
build_app:
  stage: build
  extends: .default_docker_job
  script:
    - echo "Building Docker image..."
    - docker build -t "$IMAGE_NAME:$IMAGE_TAG" .

    - echo "Saving Docker image to artifact..."
    - docker save "$IMAGE_NAME:$IMAGE_TAG" -o "$IMAGE_TAR"

    - ls -lh "$IMAGE_TAR"
  artifacts:
    when: always
    paths:
      - "$IMAGE_TAR"

# -------------------------------
# STAGE 2 — RUN *YOUR* SBOM PIPELINE + TRIVY
# -------------------------------
generate_sbom:
  stage: sbom
  extends: .default_docker_job
  dependencies:
    - build_app
  script:
    - echo "Loading Docker image from artifact..."
    - docker load -i "$IMAGE_TAR"

    - echo "Installing PowerShell..."
    - apk add --no-cache powershell

    - echo "Pulling Syft..."
    - docker pull anchore/syft:latest

    - echo "Running your SBOM generator..."
    - pwsh ./generate-sbom.ps1

    - echo "Running your NTIA validation..."
    - pwsh ./check-ntia.ps1 sbom-enriched.json

    - echo "Pulling Trivy..."
    - docker pull aquasec/trivy:latest

    - echo "Running Trivy vulnerability scan on enriched SBOM..."
    - docker run --rm -v "$PWD:/work" aquasec/trivy:latest sbom /work/sbom-enriched.json --severity HIGH,CRITICAL --format table > vuln-report.txt || true

    - echo "Listing outputs..."
    - ls -lh sbom-cyclonedx.json sbom-enriched.json vuln-report.txt

  artifacts:
    when: always
    paths:
      - sbom-cyclonedx.json
      - sbom-enriched.json
      - vuln-report.txt
